function [Vd,AdXinvXdVd,V,Xerr,control] = FeedbackControl(X,Xd,Xdnext,Kp,Ki,dt,thetalist)
%UNTITLED4 åé¦ˆæ§åˆ¶ç®—æ³•ï¼šé…å¤‡æœºæ¢°è‡‚çš„éº¦å…‹çº³å§†è½®æ™ºèƒ½è½¦è¿åŠ¨å­¦ä»»åŠ¡ç©ºé—´çš„å‰é¦ˆ+PIåé¦ˆæ§åˆ¶ç®—æ³•ï¼š
%   å½“å‰æ—¶åˆ»ï¼Œå®é™…çš„æœ«ç«¯æ‰§è¡Œå™¨çš„ä½å‹ğ‘‹
%   å½“å‰æ—¶åˆ»ï¼Œå‚è€ƒè½¨è¿¹ä¸ŠæœŸæœ›çš„æœ«ç«¯æ‰§è¡Œå™¨çš„ä½å‹ğ‘‹ğ‘‘
%   ä¸‹ä¸€æ—¶åˆ»ï¼ˆâˆ†ğ‘¡æ—¶é—´åï¼‰ï¼Œå‚è€ƒè½¨è¿¹ä¸Šçš„æœ«ç«¯æ‰§è¡Œå™¨çš„ä½å‹ğ‘‹ğ‘‘,ğ‘›ğ‘’ğ‘¥ğ‘¡
%   PI æ§åˆ¶å™¨çš„å¢ç›ŠçŸ©é˜µğ¾ğ‘å’Œğ¾ğ‘–,å‡ä¸ºå¯¹è§’é˜µ(ä¾‹å¦‚ğ¾ğ‘=ğ¾ğ‘–=ğ‘’ğ‘¦ğ‘’(6),å³6Ã—6çš„å•ä½çŸ©é˜µ)ï¼› 
%   ä¸¤ä¸ªç›¸é‚»å‚è€ƒè½¨è¿¹ä½å½¢ï¼ˆğ‘‹ğ‘‘å’Œğ‘‹ğ‘‘,ğ‘›ğ‘’ğ‘¥ğ‘¡ï¼‰é—´çš„æ—¶é—´é—´éš”ï¼Œå³æ­¥é•¿âˆ†ğ‘¡ï¼ˆä¾‹å¦‚0.01ğ‘ ğ‘’ğ‘ï¼‰ã€‚ 

Vd = se3ToVec(1/dt*MatrixLog6(Xd\Xdnext));

AdXinvXdVd = Adjoint(X\Xd)*Vd;


Xerr = se3ToVec(MatrixLog6(X\Xd));

V = AdXinvXdVd + Kp*Xerr + Ki*(Xerr*dt);

Blist = [[0;0;1;0;0.033;0],...
    [0;-1;0;-0.5076;0;0],...
     [0; -1;  0; -0.3526; 0;  0],... 
       [0; -1;  0; -0.2176; 0;  0],... 
       [0;   0;  1;  0;      0;  0]]; 


%thetalist = [0;  0;  0.2; -1.6;  0];%å¯ä¿®æ”¹
Jarm = JacobianBody(Blist, thetalist);

Tb0 = [ 1  0  0  0.1662; 
     0  1  0  0; 
          0  0  1  0.0026; 
     0  0  0  1]; 
T0b = inv(Tb0); 

M0e = [ 1  0  0  0.033; 
    0  1  0  0; 
          0  0  1  0.6546; 
     0  0  0  1]; 

T0e = FKinBody(M0e, Blist, thetalist); 
Te0 = inv(T0e); 
r = 0.0475; % radius of whell 
l = 0.47/2; % Lçš„å°å†™lï¼Œä¸ä¸‹é¢çš„1ä½œåŒºåˆ† 
w = 0.3/2;  % w 
 
F6 = [ 0        0        0        0      ; 
        0        0        0        0      ; 
     -1/(l+w)  1/(l+w)  1/(l+w) -1/(l+w); 
        1        1        1        1      ; 
       -1        1       -1        1      ; 
              0        0        0        0      ;]*r/4; 
%å¾—åˆ°æ™ºèƒ½è½¦çš„é›…å¯æ¯”çŸ©é˜µ 
Jbase = Adjoint(Te0*T0b)*F6; 
%ç»„åˆæœºæ¢°è‡‚å’Œæ™ºèƒ½è½¦çš„é›…å…‹æ¯”çŸ©é˜µ 
Je = [Jbase Jarm] ;
control = pinv(Je)*V ;

end