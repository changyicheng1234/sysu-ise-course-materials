# 重新上传删除数据后的仓库

## 问题说明

你遇到了 HTTP 500 错误，推送了 5.35 GiB 的数据但失败了。这是因为：

1. **大文件仍在 Git 历史中**：虽然你删除了本地文件，但如果这些文件之前被提交过，它们仍然在 Git 历史记录中
2. **GitHub 限制**：GitHub 对单次推送的大小有限制，5.35 GiB 太大了

## 解决方案

我已经创建了两个脚本帮你处理：

### 方法一：使用批处理脚本（推荐）

直接双击运行：
```
重新上传删除数据后的仓库.bat
```

### 方法二：使用 PowerShell 脚本

在 PowerShell 中运行：
```powershell
.\重新上传删除数据后的仓库.ps1
```

## 脚本会做什么

1. ✅ 检查 Git 状态
2. ✅ 确认 .gitignore 配置正确
3. ✅ 从 Git 索引中移除已删除的文件
4. ✅ 移除被 .gitignore 忽略但仍在跟踪的文件
5. ✅ 添加当前文件（只添加未被忽略的文件）
6. ✅ 创建提交
7. ✅ 推送到 GitHub（配置更大的缓冲区）

## 如果仍然失败

如果脚本运行后仍然遇到 HTTP 500 错误，说明大文件仍在 Git 历史记录中。需要清理历史记录：

### 选项 1：使用 git filter-branch（复杂但有效）

**PowerShell 版本**（推荐，已创建脚本）：
```powershell
# 直接运行脚本
.\清理Git历史中的大文件.ps1
```

**或者手动执行**（PowerShell 中需要将命令写在一行）：
```powershell
# 移除计算机视觉大目录的所有历史记录
git filter-branch --force --index-filter "git rm -rf --cached --ignore-unmatch '计算机视觉/Plant-Pathology-sysu-2023-main'" --prune-empty --tag-name-filter cat -- --all

# 强制垃圾回收
git for-each-ref --format='delete %(refname)' refs/original | git update-ref --stdin
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# 强制推送（⚠️ 会覆盖远程历史）
git push origin --force --all
```

**Bash/Git Bash 版本**：
```bash
# 移除计算机视觉大目录的所有历史记录
git filter-branch --force --index-filter \
  "git rm -rf --cached --ignore-unmatch '计算机视觉/Plant-Pathology-sysu-2023-main'" \
  --prune-empty --tag-name-filter cat -- --all

# 强制垃圾回收
git for-each-ref --format='delete %(refname)' refs/original | git update-ref --stdin
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# 强制推送（⚠️ 会覆盖远程历史）
git push origin --force --all
```

**注意**：PowerShell 不支持 `\` 续行符，必须将命令写在一行，或使用我创建的脚本。

### 选项 2：创建新分支（简单但会丢失历史）

```bash
# 创建一个新的孤立分支
git checkout --orphan new-main

# 添加所有当前文件
git add .

# 提交
git commit -m "清理后的新版本"

# 删除旧的 main 分支
git branch -D main

# 重命名当前分支为 main
git branch -m main

# 强制推送
git push -f origin main
```

### 选项 3：使用 BFG Repo-Cleaner（推荐，但需要安装）

1. 下载 BFG：https://rtyley.github.io/bfg-repo-cleaner/
2. 运行：
```bash
java -jar bfg.jar --delete-folders "计算机视觉/Plant-Pathology-sysu-2023-main"
git reflog expire --expire=now --all
git gc --prune=now --aggressive
git push origin --force --all
```

## 预防措施

为了避免将来再次遇到这个问题：

1. ✅ **确保 .gitignore 正确配置**：在提交前检查
2. ✅ **不要提交大文件**：使用 Git LFS 或外部存储
3. ✅ **定期清理历史**：如果发现大文件，及时清理

## 当前 .gitignore 配置

你的 .gitignore 已经配置了：
- `计算机视觉/Plant-Pathology-sysu-2023-main/` - 大图片目录
- `*.jpg`, `*.jpeg`, `*.png` 等 - 图片文件
- `*.zip`, `*.rar` 等 - 压缩包
- `*.pth`, `*.pt` 等 - 模型文件
- `*.csv`, `*.xlsx` 等 - 数据文件

这些配置是正确的，问题在于历史记录中可能还有这些文件。

## 建议

**最简单的方法**：先运行 `重新上传删除数据后的仓库.bat`，如果还是失败，使用**选项 2（创建新分支）**，这样可以快速解决问题，虽然会丢失 Git 历史记录，但对于课程作业仓库来说通常不是问题。
